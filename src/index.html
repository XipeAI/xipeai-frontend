
<!DOCTYPE html>
<html>
<head>
    <title>DICOM Viewer</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://unpkg.com/cornerstone-core"></script>
    <script src="https://unpkg.com/cornerstone-math"></script>
    <script src="https://unpkg.com/cornerstone-tools"></script>
    <script src="https://unpkg.com/cornerstone-wado-image-loader"></script>
    <script src="https://unpkg.com/dicom-parser"></script>
    <script>
        cornerstoneWADOImageLoader.external.cornerstone = cornerstone;
        cornerstoneWADOImageLoader.external.dicomParser = dicomParser;
    </script>
    <style>
 
        /* Base styles */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            background-color: #f4f4f4;
            color: #333;
        }
     
        /* Center the title */
        h2 {
            text-align: center;
        }
     
        /* Flex container */
        #layout {
            display: flex;
            flex-wrap: nowrap; /* Prevents flex items from wrapping */
            align-items: flex-start;
            justify-content: space-between; /* Distributes space between and around content items */
        
            margin-top: 20px; /* Space for the title */
        }
     
        /* DICOM Viewer styles */
        #dicomViewer {
            flex: 1; /* Allocate half of the available space */
            width: 50%; /* Adjust width if necessary */
            height: 500px; /* New height for the DICOM viewer */
            display: flex; /* Use flexbox for centering the content */
            justify-content: center; /* Center horizontally in the flex container */
            align-items: center; /* Center vertically in the flex container */
            border: 1px solid #ddd; /* A light grey border */
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); /* A subtle shadow for depth */
            padding: 10px; /* Space inside the viewer */
        }

         /* Slider styles */
         #slider-container {
            width: 100%;
            margin-top: 20px;
        }
        
        input[type='range'] {
            width: 100%;
            cursor: pointer;
        }
     
     
        /* DICOM Metadata Table styles */
        #dicom-metadata-table {
            flex: 1; /* Allocate the other half of the available space */
            border-collapse: collapse;
            margin-left: 20px; /* You can remove this if you want the table to use the full half space */
        }
     
        #dicom-metadata-table th, #dicom-metadata-table td {
            border: 1px solid #ddd; /* Consistent with the viewer border */
            padding: 10px; /* More space for content */
            text-align: left; /* Align text to the left */
        }
     
        #dicom-metadata-table th{
                background-color: #009879;
                color: #ffffff;
            }
     
        #dicom-metadata-table tr:nth-of-type(even) {
                background-color: #d4d4d4;
               }
     
        #dicom-metadata-table tbody tr:last-of-type {
            border-bottom: 2px solid #009879;
            }
     
           
        /* Responsive Design */
        @media (max-width: 768px) {
            /* Stack the layout on smaller screens */
            #layout {
                flex-direction: column;
            }
     
            #dicomViewer,
            #dicom-metadata-table {
                width: 100%; /* Full width on smaller screens */
                margin-left: 0; /* Remove the margin on smaller screens */
            }  
           
        }
     
        /* Style for file input */
        input[type="file"] {
                display: none; /* Hide the default file input */
        }
       
        .custom-file-upload {
                border: 1px solid #ccc;
                display: inline-block;
                padding: 6px 12px;
                cursor: pointer;
                background-color: #009879; /* Change background color */
                color: #fff; /* Change text color */
                border-radius: 4px; /* Add rounded corners */
        }
     
        /* Style for upload button */
        input[type="submit"] {
                border: none;
                background-color: #009879; /* Change background color */
                color: #fff; /* Change text color */
                padding: 10px 20px; /* Adjust padding */
                border-radius: 4px; /* Add rounded corners */
                cursor: pointer;
            }
     
        input[type="submit"]:hover {
                background-color: #007b66; /* Darken color on hover */
        }

    </style>
</head>
<body>
    <h2>XipeAI | DICOM Viewer</h2>
    <form action="/upload" method="post" enctype="multipart/form-data">
        <label for="file-upload" class="custom-file-upload">Choose File</label>
        <input id="file-upload" type="file" name="file" accept=".zip" onchange="updateFileName(this)">
        <span id="file-name">No file chosen</span>
        <input type="submit" value="Upload">
    </form>

    <form action="/uploadsegmented" method="post" enctype="multipart/form-data">
        <label for="segmentation-upload" class="custom-file-upload">Choose segmentation</label>
        <input id="segmentation-upload" type="file" name="file" accept=".zip" onchange="updateSegmentationName(this)">
        <span id="segmentation-name">No file chosen</span>
        <input type="submit" value="Upload">
    </form>

    <!-- Windowing Controls -->
    <div id="windowing-controls">
        <label for="window-width">Window Width:</label>
        <input type="range" id="window-width" min="1" max="4000" value="150" onchange="applyWindowing()">
        <label for="window-level">Window Level:</label>
        <input type="range" id="window-level" min="-1024" max="3071" value="60" onchange="applyWindowing()">
    </div>

    <div id="layout">
        <!-- DICOM Viewer -->
        <div id="dicomViewer"></div>

        <!-- DICOM Metadata Table -->
        <table id="dicom-metadata-table">
            <tr><th>Field</th><th>Value</th></tr>
            <!-- Metadata rows will be inserted here by JavaScript -->
        </table>
    </div>

    <!-- Slider Container placed below the DICOM Viewer and Metadata Table -->
    <div id="slider-container">
        <input type="range" id="dicom-slider" min="0" value="0">
    </div>
 
    <script>

        function updateFileName(input) {
            document.getElementById('file-name').textContent = input.files.length > 0 ? input.files[0].name : 'No file chosen';
        }


        function applyWindowing() {
                const element = document.getElementById('dicomViewer');
                const viewport = cornerstone.getViewport(element);

                // Retrieve the window width and window level from the input sliders
                const windowWidth = document.getElementById('window-width').value;
                const windowLevel = document.getElementById('window-level').value;

                // Apply the windowing parameters
                viewport.voi.windowWidth = parseInt(windowWidth, 10);
                viewport.voi.windowCenter = parseInt(windowLevel, 10);

                // Update the viewport with the new settings
                cornerstone.setViewport(element, viewport);
            }


        $(document).ready(function() {
            let currentIndex = 0;
            let dicomFiles = [];
            let segmentationFiles = []; // Array to store segmentation file paths

            const dicomViewerElement = document.getElementById('dicomViewer');

            cornerstone.enable(dicomViewerElement);

            function loadDicomImage(imageIndex) {
                const imageId = `wadouri:http://127.0.0.1:5000/dicom/${dicomFiles[imageIndex]}`;
                console.log(imageId);
                cornerstone.loadImage(imageId).then(function(image) {
                    cornerstone.displayImage(dicomViewerElement, image);
                    applyWindowing(dicomViewerElement); // Apply windowing to the DICOM image
                    // After displaying the DICOM image, overlay the segmentation
                    loadAndOverlaySegmentation(imageIndex);
                });
            }

            function loadAndOverlaySegmentation(imageIndex) {
                // Load the segmentation DICOM similar to the original DICOM
                const segmentationImageId = `wadouri:http://127.0.0.1:5000/segmentation/${segmentationFiles[imageIndex]}`;
                cornerstone.loadImage(segmentationImageId).then(function(segmentationImage) {
                    // Assuming 'pixelData' is your Int16Array from the DICOM segmentation image
                    const pixelData = segmentationImage.getPixelData();
                    
                    // Create a canvas to draw the segmentation overlay
                    const canvas = document.createElement('canvas');
                    canvas.width = segmentationImage.width;
                    canvas.height = segmentationImage.height;
                    const context = canvas.getContext('2d');
                    
                    // Create an ImageData object to hold our colored segmentation
                    const imageData = context.createImageData(canvas.width, canvas.height);
                    const data = imageData.data;

                    // Loop through the segmentation data and color-code the pixels
                    for (let i = 0; i < pixelData.length; i++) {
                        const index = i * 4; // Index in the RGBA array
                        if (pixelData[i] === 1) {
                            // Liver - Color it red
                            data[index] = 0; // Red
                            data[index + 1] = 255; // Green
                            data[index + 2] = 0; // Blue
                            data[index + 3] = 64; // Alpha (half transparent)
                        } else if (pixelData[i] === 2) {
                            // Tumor - Color it green
                            data[index] = 255; // Red
                            data[index + 1] = 0; // Green
                            data[index + 2] = 0; // Blue
                            data[index + 3] = 128; // Alpha (half transparent)
                        }
                    }

                    // Put the colored segmentation data back on the canvas
                    context.putImageData(imageData, 0, 0);

                    // Now overlay this canvas onto the original DICOM viewer element
                    overlaySegmentationOnDicomViewer(dicomViewerElement, canvas);
                });
            }

            function overlaySegmentationOnDicomViewer(dicomViewerElement, segmentationCanvas) {
                const cornerstoneCanvas = $(dicomViewerElement).find('canvas').get(0);
                if (!cornerstoneCanvas) {
                    console.error('DICOM Viewer canvas not found.');
                    return;
                }

                const ctx = cornerstoneCanvas.getContext('2d');
                ctx.drawImage(segmentationCanvas, 0, 0);
            }


 
            function populateMetadataTable(metadata) {
            const table = document.getElementById('dicom-metadata-table');
            // Clear existing table rows, except for the header
            table.innerHTML = '<tr><th>Field</th><th>Value</th></tr>';

            // Helper function to generate random data for demonstration purposes
            function getRandomData(field) {
                switch(field) {
                    case 'Patient Name':
                        return 'John Doe';
                    case 'Patient Birth Date':
                        return '1980-01-01'; // Default random birth date
                    case 'Body Part Examined':
                        return 'Head';
                    case 'Study Time':
                        return '14:30:00';
                    case 'Accession Number':
                        return Math.random().toString(36).slice(2, 10);
                    case 'Modality':
                        return 'CT';
                    case 'Study Description':
                        return 'Routine checkup';
                    default:
                        return 'Random Value';
                }
            }
            function updateProgressBar(currentIndex, totalFiles) {
            const progressPercentage = (currentIndex / totalFiles) * 100;
            document.getElementById('progress-bar').style.width = `${progressPercentage}%`;
        }

            
            function formatBirthDate(dateString) {
                if (dateString && dateString.length === 8) {
                    return dateString.substring(0, 4) + '-' + dateString.substring(4, 6) + '-' + dateString.substring(6, 8);
                }
                return dateString;
            }

            // Populate the table with metadata or random dummy data if 'NA'
            metadata.forEach(function(fieldInfo) {
                const row = table.insertRow(-1);
                const cellField = row.insertCell(0);
                const cellValue = row.insertCell(1);
                cellField.textContent = fieldInfo['Field'];
                
                let value = fieldInfo['Value'] !== 'NA' ? fieldInfo['Value'] : getRandomData(fieldInfo['Field']);
                if (fieldInfo['Field'] === 'Patient Birth Date') {
                    value = formatBirthDate(value);
                }
                
                cellValue.textContent = value;
            });
        }


 
            function fetchAndDisplayMetadata(filename) {
                $.getJSON(`/dicom-metadata/${filename}`, function(metadata) {
                    populateMetadataTable(metadata);
                }).fail(function() {
                    console.error("Failed to load DICOM metadata");
                });
            }
 
            // Fetch the list of DICOM files
            $.getJSON('/list-dicom-files', function(files) {
                dicomFiles = files;
                if (dicomFiles.length > 0) {
                    loadDicomImage(0); // Load the first DICOM image
                    updateProgressBar(currentIndex, dicomFiles.length); // Set initial progress bar status
                }
            });

            // Fetch the list of segmentation files
            $.getJSON('/list-segmentation-files', function(files) {
                segmentationFiles = files;
                if (segmentationFiles.length > 0) {
                    loadSegmentationImage(0); // Load the first segmentation image
                    
                }
            });

            // Slider event listener
            const slider = document.getElementById('dicom-slider');
            // Slider event listener
            slider.addEventListener('input', function(e) {
                const index = parseInt(e.target.value, 10);
                currentIndex = index;
                loadDicomImage(index);
                loadSegmentationImage(index); // Update the segmentation viewer as well
                updateProgressBar(currentIndex, dicomFiles.length); // Updated to call with the correct parameters
            });
 
            // Adjusted scrolling event listener
            $(dicomViewerElement).on('mousewheel DOMMouseScroll', function(e) {
                e.preventDefault();
                const delta = e.originalEvent.wheelDelta || -e.originalEvent.detail;
                currentIndex = Math.max(0, Math.min(currentIndex + (delta > 0 ? -1 : 1), dicomFiles.length - 1));
                loadDicomImage(currentIndex);
                loadSegmentationImage(currentIndex);
                updateProgressBar(currentIndex, dicomFiles.length); // Ensure the progress bar is updated on scroll
            });

            function updateProgressBar(currentIndex, totalFiles) {
                // Adjusted to account for zero-based indexing; ensures the first image shows some progress and the last image fills the bar
                const progressPercentage = ((currentIndex + 1) / totalFiles) * 100;
                document.getElementById('progress-bar').style.width = `${progressPercentage}%`;
            }

        });
</script>
</body>
</html>